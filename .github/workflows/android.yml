name: Android Unit Tests

on:
  push:
    paths:
      - 'mobile/**'
    branches:
      - main
      - develop
  pull_request:
    paths:
      - 'mobile/**'
  workflow_dispatch: # Permitir ejecuci√≥n manual

jobs:
  test:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        api-level: [33]
        target: [default]
        arch: [x86_64]

    defaults:
      run:
        working-directory: mobile # Cambiar directorio de trabajo a 'mobile'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: Install xmllint
      run: sudo apt-get install -y libxml2-utils

    - name: Run Unit Tests
      run: ./gradlew testDebugUnitTest jacocoTestReport

    - name: List Directories
      run: |
        echo "Listing directories and files in mobile/build:"
        ls -R build

    - name: Check if JaCoCo report exists
      if: success()
      run: |
        if [ ! -f build/reports/jacoco/testDebugUnitTest/jacocoTestReport.xml ]; then
          echo "JaCoCo report not found!"
          exit 1
        else
          echo "JaCoCo report found."
        fi
      continue-on-error: false

    - name: Verify Coverage
      if: success()
      run: |
        # Verifica si el archivo XML de JaCoCo existe
        if [ ! -f build/reports/jacoco/testDebugUnitTest/jacocoTestReport.xml ]; then
          echo "JaCoCo report not found!"
          exit 1
        fi

        # Calcula la cobertura de los ViewModels a partir del archivo XML de JaCoCo
        COVERAGE=$(xmllint --xpath "number(//report/package[@name='com/uniandes/abcall/viewmodel']/counter[@type='LINE']/@covered)" build/reports/jacoco/testDebugUnitTest/jacocoTestReport.xml)
        MISSED=$(xmllint --xpath "number(//report/package[@name='com/uniandes/abcall/viewmodel']/counter[@type='LINE']/@missed)" build/reports/jacoco/testDebugUnitTest/jacocoTestReport.xml)
        TOTAL=$((COVERAGE + MISSED))
        PERCENT=$((COVERAGE * 100 / TOTAL))
        echo "Line Coverage for ViewModels: $PERCENT%"
        if [ $PERCENT -lt 70 ]; then
          echo "Coverage for ViewModels is below 70%"
          exit 1
        fi
      continue-on-error: false

    - name: Archive test results
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: build/reports/tests/testDebugUnitTest
